# Arduinoタイミングコントローラー（リレー・PWMモーター・電磁石・7セグメントディスプレイ付き）

このプロジェクトは、Arduino Unoを使用して2つのDCモーターと1つの電磁石モジュールを正確なタイミングロジックで制御します。TM1637の4桁7セグメントLEDディスプレイにより、カウントダウンとサイクルの進行状況を表示します。システムは、モーターと電磁石の同期動作、ユーザー入力の処理、視覚的なフィードバックを伴うタイミング制御サイクルを実行します。

## 🔧 使用部品

- Arduino Uno  
- L298モータードライバ（Motor2にはPWM対応ピンが必要）  
- DCモーター ×2（例：RE-280RA）  
- 電磁石 ×1（例：KEYESTUDIO）  
- TM1637 4桁7セグメントLEDディスプレイ  
- プッシュボタンスイッチ ×2（スタート用とMotor1用）  
- Motor2停止用の圧電センサー  
- 外部電源（モーターと電磁石用に推奨）  
- Motor1およびMotor2の状態表示用リレーモジュール（任意）

## 📍 ピン設定

| コンポーネント               | Arduinoピン |
|-----------------------------|-------------|
| 電磁石                      | D2          |
| TM1637 CLK                  | D4          |
| TM1637 DIO                  | D5          |
| スタートスイッチ入力        | D6          |
| Motor1スイッチ入力          | D7          |
| Motor2圧電センサー入力      | D8          |
| Motor1状態出力（リレー）    | D9          |
| Motor2状態出力（リレー）    | D10         |
| Motor2 IN1（PWM）           | D11         |
| Motor2 IN2（PWM）           | D12         |
| LEDインジケーター           | D13         |

> ⚠️ 注意：Motor2のIN1およびIN2は、PWM対応のArduino Unoピンに接続する必要があります。  
> D9およびD10は、Motor1またはMotor2が動作中にHIGHになります。  
> 両方のスイッチは `INPUT_PULLUP` 設定を使用しています。

## ⏱️ 動作概要

- システムは **READY_PHASE** で起動し、「READY」メッセージがスクロール表示されます。  
- **スタートスイッチ**を押すと、**COOL_PHASE**（5秒の休止）に移行します。  
- 休止後、システムは **ACTIVE_PHASE**（30秒の動作サイクル）に入ります。  
- このサイクルは、アクティブとクールフェーズを交互に **10回繰り返し**ます。  
- 10回目のサイクル終了後、ディスプレイに `FIN` がスクロール表示され、システムがリセットされます。

## 🔹 Motor1スイッチ制御

- **ACTIVE_PHASE** 中に **モーメンタリースイッチ（D7）** を押すと、Motor1が **10秒間起動**します。  
- **押すたびに10秒タイマーがリセット**されるため、連続して押すことで動作時間を延長できます。  
- フェーズがCOOLまたはREADYに移行すると、Motor1は即座に停止します。  
- Motor1が動作中は、**D9がHIGH**になり、外部機器のリレー制御が可能になります。  
- スイッチ入力がない場合、Motor1は **ACTIVE_PHASEの残り20秒時点で自動起動**します。

## 🔹 Motor2の動作

- Motor2は **ACTIVE_PHASE** 中に自動的に起動します。  
- **圧電センサー（D8）**を押すと、ヒットカウントが増加します。  
- **5回ヒット**すると、Motor2はそのサイクルの残り時間中停止します。  
- ヒットがない場合でも、**残り10秒になると自動的に停止**します。  
- Motor2が動作中は、**D10がHIGH**になり、リレー制御が可能です。

## 🔹 7セグメントディスプレイ

- **左2桁**：フェーズの残り秒数  
- **右2桁**：現在のサイクル番号  
- Motor1の10秒タイマー中は、対応する桁が回転表示されます。  
- READY_PHASEでは「READY」メッセージがスクロール表示されます。  
- 10サイクル終了後、「FIN」がスクロール表示されます。

## 🔹 ACTIVEフェーズの動作

- **30秒のアクティブフェーズ**では：  
  - Motor2が自動的に起動  
  - Motor1はスイッチ操作で10秒間起動（押すたびに延長可能）  
  - 電磁石は各サイクルの開始時に10秒間起動  
- Motor1はフェーズの境界を尊重し、フェーズ変更時に停止します。  
- カウントダウンは `millis()` を使用して毎秒更新（非ブロッキング）

## 🔹 COOLフェーズの動作

- **5秒の休止フェーズ**では：  
  - モーターはすべて停止  
  - READYスクロールアニメーションは非表示（ちらつき防止）  
  - 電磁石はOFFのまま

## 🎚️ PWMモーター制御

- Motor2は `analogWrite()` を使用して滑らかな速度制御を行います。  
- PWM出力はデフォルトで255（最大速度）に設定されています。

## 🧲 電磁石制御

- 電磁石は各アクティブサイクルの開始時に10秒間起動します。  
- 他の処理を妨げない独立したタイミング制御です。

## ⌚ タイミングロジック

- すべてのタイミングは `millis()` を使用し、非ブロッキングで処理されます。  
- Motor1の10秒タイマーは **ACTIVE_PHASE中にボタンを押すたびにリセット**されますが、フェーズ変更でキャンセルされます。  
- 圧電センサー入力は80msのデバウンス処理で誤検出を防止します。  
- Motor2はヒットがなくても、ACTIVE_PHASEの残り10秒で自動停止します。

## 📄 コードの特徴

- Motor1：リレー制御、ACTIVE_PHASE中にボタンを繰り返し押すことで10秒タイマーを延長可能  
- Motor2：PWM速度制御、圧電センサーで5回ヒットすると停止、またはACTIVE_PHASEの残り10秒で自動停止  
- `millis()` を使用した非ブロッキングなフェーズカウントダウン  
- 電磁石：独立した10秒間の起動制御  
- 7セグメントディスプレイ：カウントダウン、サイクル番号、Motor1の回転アニメーション表示  
- READYとFINメッセージのスクロール表示機能  
- Motor1とMotor2のリレー対応状態出力（D9/D10）  
- モーター制御、表示、電磁石タイミングを分離したモジュール関数構成

## 🚀 はじめ方

1. ピン設定に従ってすべての部品を接続する  
2. Arduinoスケッチをアップロードする  
3. モーターと電磁石に外部電源を供給する  
4. スタートスイッチを押してシステムを起動する  
5. カウントダウンサイクル、Motor2の動作、Motor1の回転アニメーション、圧電センサーの検出、電磁石の起動を確認する  
6. D9およびD10を使用して、リレー制御や外部機器のモニタリングを行う

## 🛠️ カスタマイズのアイデア

- Motor2のPWM出力を調整して速度を最適化  
- ディスプレイの更新間隔を調整してアニメーションを滑らかに  
- 電磁石やMotor1の動作中にブザーやLEDなどのフィードバックを追加  
- `FIN`表示後に追加メッセージを表示する  
- D9/D10を使ってファン・ライト・アラームなど外部機器を制御する

## 📜 ライセンス

このプロジェクトはMITライセンスのもとで提供されています。  
詳細は [LICENSE](LICENSE) ファイルをご確認ください。
